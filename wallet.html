<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DitPay - Wallet</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <h1>DitPay Wallet</h1>
    <nav>
      <a href="dashboard.html">Home</a>
      <a href="wallet.html">Wallet</a>
      <a href="transactions.html">Transactions</a>
      <a href="profile.html">Profile</a>
    </nav>
  </header>

  <main class="content">
    <div class="container">
      <h2>Your Wallet</h2>
      <p><strong>Balance:</strong> ₦<span id="balance">0.00</span></p>

      <!-- Buttons -->
      <button id="fundBtn">💳 Fund Wallet</button>
      <button id="refreshBtn">🔄 Refresh Balance</button>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 DitPay. All Rights Reserved.</p>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const API_BASE = "https://dit-pay.onrender.com"; // ✅ Your backend URL
      const balanceEl = document.getElementById("balance");
      const fundBtn = document.getElementById("fundBtn");
      const refreshBtn = document.getElementById("refreshBtn");

      // ✅ Load wallet balance
      async function loadWallet() {
        try {
          const res = await fetch(`${API_BASE}/wallet`, {
            headers: {
              "Authorization": "Bearer " + localStorage.getItem("token"),
            },
          });
          const data = await res.json();
          if (res.ok) {
            balanceEl.innerText = parseFloat(data.balance || 0).toFixed(2);
          } else {
            alert(data.message || "Unable to fetch wallet balance.");
          }
        } catch (err) {
          console.error("Error loading wallet:", err);
          alert("Error loading wallet.");
        }
      }

      // ✅ Fund wallet using Paystack
      function fundWallet() {
        const amount = prompt("Enter amount to fund (₦):");
        if (!amount || isNaN(amount) || amount <= 0)
          return alert("Enter a valid amount.");

        if (typeof PaystackPop === "undefined") {
          alert("⚠️ Paystack script not loaded. Please refresh the page.");
          return;
        }

        const handler = PaystackPop.setup({
          key: "pk_live_a58e433c09f1575cb5d7517ccfed4eb3ce3aab7b", // ✅ Your Paystack public key
          email: localStorage.getItem("userEmail") || "customer@example.com",
          amount: parseFloat(amount) * 100, // in kobo
          currency: "NGN",
          ref: "DITPAY-" + Date.now(),
          callback: async function (response) {
            try {
              const verifyRes = await fetch(`${API_BASE}/wallet/fund`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + localStorage.getItem("token"),
                },
                body: JSON.stringify({
                  amount: parseFloat(amount),
                  reference: response.reference,
                }),
              });

              const verifyData = await verifyRes.json();
              alert(verifyData.message || "Wallet funded successfully!");
              if (verifyRes.ok) loadWallet();
            } catch (err) {
              console.error("Error verifying payment:", err);
              alert("Error verifying payment.");
            }
          },
          onClose: function () {
            alert("Transaction cancelled.");
          },
        });

        handler.openIframe();
      }

      // ✅ Event listeners
      fundBtn.addEventListener("click", fundWallet);
      refreshBtn.addEventListener("click", loadWallet);

      // ✅ Load balance on startup
      loadWallet();
    });
  </script>

  <!-- ✅ Load Paystack script at the very end -->
  <script src="https://js.paystack.co/v1/inline.js"></script>
</body>
</html>
