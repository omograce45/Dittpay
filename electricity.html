<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DitPay - Pay Electricity</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Pay Electricity Bill</h1>
    <nav>
      <a href="dashboard.html">Home</a>
      <a href="wallet.html">Wallet</a>
      <a href="transactions.html">Transactions</a>
      <a href="profile.html">Profile</a>
    </nav>
  </header>

  <main class="content">
    <div class="container">
      <h2>Electricity Bill Payment</h2>

      <form id="electricityForm">
        <!-- Meter Number -->
        <label for="meter">Meter Number:</label>
        <input type="text" id="meter" placeholder="1234567890" required><br><br>

        <!-- DisCo Provider -->
        <label for="disco">DisCo Provider:</label>
        <select id="disco" required>
          <option value="">-- Choose Provider --</option>
          <option value="01">Eko Electric - EKEDC</option>
          <option value="02">Ikeja Electric - IKEDC</option>
          <option value="03">Abuja Electric - AEDC</option>
          <option value="04">Kano Electric - KEDC</option>
          <option value="05">Port Harcourt Electric - PHEDC</option>
          <option value="06">Jos Electric - JEDC</option>
          <option value="07">Ibadan Electric - IBEDC</option>
          <option value="08">Kaduna Electric - KAEDC</option>
          <option value="09">Enugu Electric - EEDC</option>
          <option value="10">Benin Electric - BEDC</option>
          <option value="11">Yola Electric - YEDC</option>
          <option value="12">Aba Electric - APLE</option>
        </select><br><br>

        <!-- Meter Type -->
        <label for="meterType">Meter Type:</label>
        <select id="meterType" required>
          <option value="">-- Select Type --</option>
          <option value="01">Prepaid</option>
          <option value="02">Postpaid</option>
        </select><br><br>

        <!-- Phone Number -->
        <label for="phone">Phone Number:</label>
        <input type="text" id="phone" placeholder="08012345678" required><br><br>

        <!-- Amount -->
        <label for="amount">Amount (‚Ç¶):</label>
        <input type="number" id="amount" min="500" required><br><br>

        <!-- Verify & Pay -->
        <button type="button" onclick="verifyMeter()">üîé Verify Meter</button>
        <button type="submit">üí° Pay Electricity</button>
      </form>

      <div id="verifyResult" style="margin-top:15px; font-weight:bold;"></div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 DitPay. All Rights Reserved.</p>
  </footer>

  <script>
    const API_BASE = "https://dit-pay.onrender.com";

    // üîé Verify meter before payment
    async function verifyMeter() {
      const meter = document.getElementById("meter").value.trim();
      const disco = document.getElementById("disco").value;
      const meterType = document.getElementById("meterType").value;

      if (!meter || !disco || !meterType) {
        alert("‚ö†Ô∏è Fill all fields before verifying.");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/verify-meter`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token")
          },
          body: JSON.stringify({ meter, disco, meterType })
        });

        const data = await res.json();

        if (res.ok) {
          if (data.customer_name === "INVALID_METERNO") {
            document.getElementById("verifyResult").innerText = "‚ùå Verification failed: Invalid Meter Number";
          } else {
            document.getElementById("verifyResult").innerText = `‚úÖ Verified: ${data.customer_name} (Meter: ${meter})`;
          }
        } else {
          document.getElementById("verifyResult").innerText = `‚ùå ${data.message || "Verification failed"}`;
        }
      } catch (err) {
        document.getElementById("verifyResult").innerText = "‚ùå Error: " + err.message;
      }
    }

    // üí° Pay electricity
    document.getElementById("electricityForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const meter = document.getElementById("meter").value.trim();
      const disco = document.getElementById("disco").value;
      const meterType = document.getElementById("meterType").value;
      const phone = document.getElementById("phone").value.trim();
      const amount = document.getElementById("amount").value;

      if (!meter || !disco || !meterType || !phone || !amount) {
        alert("‚ö†Ô∏è Please fill all fields.");
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/pay-electricity`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem("token")
          },
          body: JSON.stringify({ meter, disco, meterType, phone, amount: parseFloat(amount) })
        });

        const data = await res.json();

        if (res.ok) {
          alert(`‚úÖ ${data.message}\nNew Balance: ‚Ç¶${data.new_balance || "---"}`);
        } else {
          alert(`‚ùå Payment failed: ${data.message || "Check inputs and wallet balance"}`);
        }
      } catch (err) {
        alert("‚ùå Error: " + err.message);
      }
    });
  </script>
</body>
  </html>
